{% extends "base.html" %}
{% block title %}Asistencia{% endblock %}

{% block content %}
<style>
    .asistencia-container {
        max-width: 1000px;
        margin: 30px auto;
        background-color: #ffffff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .asistencia-container h2 {
        text-align: center;
        margin-bottom: 20px;
    }

    select {
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }

    video {
        display: block;
        margin: 0 auto;
        border: 2px solid #ccc;
        border-radius: 8px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
    }

    th, td {
        padding: 12px;
        border: 1px solid #ddd;
        text-align: center;
    }

    th {
        background-color: #f0f0f0;
    }

    .estado span {
        font-weight: bold;
    }

    .presente {
        color: #2ecc71;
        font-weight: bold;
    }

    .detectado {
        color: #f39c12;
        font-weight: bold;
    }

    .no-detectado {
        color: #e74c3c;
        font-weight: bold;
    }
    .btn-confirmar {
        display: block;
        width: max-content;
        margin: 30px auto;
        padding: 12px 25px;
        background-color: #28a745;
        color: white;
        font-size: 18px;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .btn-confirmar:hover {
        background-color: #218838;
    }

    .detection-count {
        font-size: 0.8em;
        color: #666;
        margin-left: 8px;
    }
</style>

<div class="asistencia-container">
    <h2>üì∑ Registro de Asistencia</h2>

    <!-- C√°mara -->
    <video id="video" width="400" height="300" autoplay></video>

    <!-- Tabla de alumnos -->
    <h3 style="margin-top: 30px;">üßë‚Äçüéì Lista de Alumnos</h3>
    <form method="POST" action="{{ url_for('main.confirmar_asistencia', clase_id=clase_id) }}" onsubmit="return confirmarAsistencia()">
        <table>
            <tr>
                <th>Nombre</th>
                <th>RUT</th>
                <th>Estado</th>
            </tr>
            {% for alumno in alumnos %}
            <tr data-alumno-id="{{ alumno.id }}">
                <td>{{ alumno.nombre }}</td>
                <td>{{ alumno.rut }}</td>
                <td class="estado">
                    <span class="no-detectado">No detectado</span>
                    <span class="detection-count"></span>
                    <input type="hidden" name="estado_{{ alumno.id }}" value="no-detectado">
                    <input type="hidden" name="detecciones_{{ alumno.id }}" value="0">
                </td>
            </tr>
            {% endfor %}
        </table>
        <button type="submit" class="btn-confirmar">Confirmar Asistencia</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('video');
        const claseId = parseInt("{{ clase_id }}");
        let intervalId;
        // Objeto para mantener el conteo de detecciones por alumno
        const deteccionesAlumnos = {};

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                    if (video.srcObject) {
                        // Reducimos la frecuencia de captura a 5 segundos para dar tiempo al procesamiento
                        intervalId = setInterval(capturarFotograma, 5000);
                    }
                })
                .catch(function(err) {
                    video.style.display = 'none';
                    const container = document.querySelector('.asistencia-container');
                    const errorMsg = document.createElement('p');
                    errorMsg.textContent = 'No se pudo acceder a la c√°mara. Por favor, verifica los permisos.';
                    errorMsg.style.color = 'red';
                    errorMsg.style.textAlign = 'center';
                    container.insertBefore(errorMsg, video);
                });
        } else {
            const container = document.querySelector('.asistencia-container');
            const errorMsg = document.createElement('p');
            errorMsg.textContent = 'La funcionalidad de c√°mara no es compatible con este navegador.';
            errorMsg.style.color = 'red';
            errorMsg.style.textAlign = 'center';
            container.insertBefore(errorMsg, video);
            video.style.display = 'none';
        }

        function capturarFotograma() {
            if (!video.srcObject || video.videoWidth === 0 || video.videoHeight === 0) {
                return;
            }
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imagenBase64 = canvas.toDataURL('image/png');

            fetch(`{{ url_for('main.procesar_fotograma', clase_id=clase_id) }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imagen: imagenBase64 })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.alumnos) {
                    actualizarEstadoAlumnos(data.alumnos);
                }
            })
            .catch(error => {
                console.error('Error al procesar el fotograma:', error.mensaje || error);
            });
        }

        function actualizarEstadoAlumnos(alumnosDetectados) {
            alumnosDetectados.forEach(alumno => {
                const fila = document.querySelector(`tr[data-alumno-id="${alumno.id}"]`);
                if (fila) {
                    const estadoCelda = fila.querySelector('.estado');
                    const spanEstado = estadoCelda.querySelector('span');
                    const spanConteo = estadoCelda.querySelector('.detection-count');
                    const inputEstado = estadoCelda.querySelector('input[name^="estado_"]');
                    const inputDetecciones = estadoCelda.querySelector('input[name^="detecciones_"]');
                    
                    if (alumno.detectado) {
                        // Incrementar contador de detecciones
                        deteccionesAlumnos[alumno.id] = (deteccionesAlumnos[alumno.id] || 0) + 1;
                        const numDetecciones = deteccionesAlumnos[alumno.id];
                        
                        // Actualizar conteo visible
                        spanConteo.textContent = `(${numDetecciones}/5)`;
                        inputDetecciones.value = numDetecciones;

                        if (numDetecciones >= 5) {
                            // Cambiar a estado "presente"
                            spanEstado.textContent = 'Presente';
                            spanEstado.className = 'presente';
                            inputEstado.value = 'presente';
                        } else {
                            // Mantener en estado "detectado"
                            spanEstado.textContent = 'Detectado';
                            spanEstado.className = 'detectado';
                            inputEstado.value = 'detectado';
                        }
                    } else if (spanEstado.textContent === 'No detectado') {
                        // Solo actualizar si no est√° ya en estado "presente" o "detectado"
                        spanEstado.textContent = 'No detectado';
                        spanEstado.className = 'no-detectado';
                        inputEstado.value = 'no-detectado';
                        // Mantener el conteo actual si existe
                        if (deteccionesAlumnos[alumno.id]) {
                            spanConteo.textContent = `(${deteccionesAlumnos[alumno.id]}/5)`;
                        }
                    }
                }
            });
        }

        window.addEventListener('beforeunload', () => {
            clearInterval(intervalId);
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });
    });

    function confirmarAsistencia() {
        // Contar cu√°ntos alumnos est√°n presentes
        const presentes = document.querySelectorAll('input[name^="estado_"][value="presente"]').length;
        const total = document.querySelectorAll('input[name^="estado_"]').length;
        
        return confirm(`¬øDeseas confirmar la asistencia?\n\n` +
                      `- ${presentes} alumno(s) marcado(s) como presente\n` +
                      `- ${total - presentes} alumno(s) marcado(s) como ausente\n\n` +
                      `Solo los alumnos con estado "Presente" (5 detecciones) ser√°n registrados como presentes.`);
    }
</script>
{% endblock %}

